working code

#include <ESP8266WiFi.h>
#include <ESP8266HTTPClient.h>
#include <WiFiClientSecure.h>
#include <EEPROM.h>
#include <ArduinoJson.h> 

// ==========================================
// CONFIGURATION
// ==========================================
#define WIFI_SSID "Lucky123"
#define WIFI_PASSWORD "ekse8tak"

#define FIREBASE_PROJECT_ID "e-box-4fbf2" 
#define API_KEY "AIzaSyC-08DKgGAmg8lclMfUv9Y8osEB8leoxcQ" 

// Wiring: Relay on D5
#define RELAY_PIN D5 
#define EEPROM_SIZE 64

// Heartbeat Settings: Send every 10 seconds
const long pingInterval = 10000; 
unsigned long lastPingTime = 0;

String deviceId; 

// ==========================================
// HELPER FUNCTIONS (ID, EEPROM)
// ==========================================
String randomChar() {
  const char chars[] = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  return String(chars[random(36)]);
}
String generateDeviceId() {
  String id = "";
  for (int i = 0; i < 16; i++) id += randomChar();
  return id;
}
void saveDeviceId(String id) {
  EEPROM.begin(EEPROM_SIZE);
  for (int i = 0; i < 16; i++) EEPROM.write(i, id[i]);
  EEPROM.commit();
}
String loadDeviceId() {
  EEPROM.begin(EEPROM_SIZE);
  char id[17];
  for (int i = 0; i < 16; i++) id[i] = EEPROM.read(i);
  id[16] = '\0';
  String sID = String(id);
  if (sID.length() != 16 || !isalnum(sID[0])) return "";
  return sID;
}

// ==========================================
// FIRESTORE FUNCTIONS
// ==========================================
String getBaseUrl() {
  return "https://firestore.googleapis.com/v1/projects/" + String(FIREBASE_PROJECT_ID) + 
         "/databases/(default)/documents";
}

// 1. SEND HEARTBEAT (Using Server Timestamp)
void sendHeartbeat() {
  WiFiClientSecure client;
  client.setInsecure();
  HTTPClient http;

  // We use the ':commit' endpoint to perform a transformation (Server Timestamp)
  String url = getBaseUrl() + ":commit?key=" + String(API_KEY);
  
  http.begin(client, url);
  http.addHeader("Content-Type", "application/json");

  // Construct JSON for "setToServerValue": "REQUEST_TIME"
  // This tells Google to write the current server time into 'lastSeen'
  StaticJsonDocument<1024> doc;
  JsonArray writes = doc.createNestedArray("writes");
  JsonObject write1 = writes.createNestedObject();
  
  String docPath = "projects/" + String(FIREBASE_PROJECT_ID) + "/databases/(default)/documents/boxes/" + deviceId;
  
  write1["update"]["name"] = docPath;
  
  // We only want to update 'lastSeen', leave other fields alone
  JsonObject updateMask = write1.createNestedObject("updateMask");
  JsonArray fieldPaths = updateMask.createNestedArray("fieldPaths");
  fieldPaths.add("lastSeen");
  
  // The Transform Logic
  JsonArray transforms = write1.createNestedArray("updateTransforms");
  JsonObject t1 = transforms.createNestedObject();
  t1["fieldPath"] = "lastSeen";
  t1["setToServerValue"] = "REQUEST_TIME";

  String jsonString;
  serializeJson(doc, jsonString);
  
  int httpCode = http.POST(jsonString); // Commit uses POST
  
  if (httpCode == 200) {
    Serial.println("Heartbeat Sent (Time Updated)");
  } else {
    Serial.print("Heartbeat Failed: "); Serial.println(httpCode);
    Serial.println(http.getString());
  }
  http.end();
}

// 2. REGISTER BOX (Initial Setup)
void registerBox() {
  WiFiClientSecure client;
  client.setInsecure();
  HTTPClient http;
  
  String url = getBaseUrl() + "/boxes/" + deviceId + "?updateMask.fieldPaths=internalId&updateMask.fieldPaths=command&key=" + String(API_KEY);
  
  http.begin(client, url);
  http.addHeader("Content-Type", "application/json");

  StaticJsonDocument<512> doc;
  JsonObject fields = doc.createNestedObject("fields");
  fields["internalId"]["stringValue"] = deviceId;
  fields["command"]["stringValue"] = "NONE"; 

  String jsonString;
  serializeJson(doc, jsonString);
  http.PATCH(jsonString);
  http.end();
}

// 3. CHECK COMMANDS (Lock/Unlock)
void checkCommand() {
  WiFiClientSecure client;
  client.setInsecure();
  HTTPClient http;

  // Regular GET request to check status
  String url = getBaseUrl() + "/boxes/" + deviceId + "?key=" + String(API_KEY);
  
  http.begin(client, url);
  int httpCode = http.GET();

  if (httpCode == 200) {
    String payload = http.getString();
    StaticJsonDocument<2048> doc;
    DeserializationError error = deserializeJson(doc, payload);

    if (error) return;

    const char* command = doc["fields"]["command"]["stringValue"];
    String cmdString = String(command);

    if (cmdString == "UNLOCK") {
      Serial.println(">>> EXECUTE: UNLOCK");
      pinMode(RELAY_PIN, OUTPUT);
      digitalWrite(RELAY_PIN, LOW); // Active Low
      resetCommand();
      sendHeartbeat(); // Update time immediately
    } 
    else if (cmdString == "LOCK") {
      Serial.println(">>> EXECUTE: LOCK");
      digitalWrite(RELAY_PIN, HIGH);
      pinMode(RELAY_PIN, INPUT); // Safety High Z
      resetCommand();
      sendHeartbeat();
    }
  }
  http.end();
}

// 4. RESET COMMAND
void resetCommand() {
  WiFiClientSecure client;
  client.setInsecure();
  HTTPClient http;
  String url = getBaseUrl() + "/boxes/" + deviceId + "?updateMask.fieldPaths=command&key=" + String(API_KEY);
  
  http.begin(client, url);
  http.addHeader("Content-Type", "application/json");
  StaticJsonDocument<200> doc;
  JsonObject fields = doc.createNestedObject("fields");
  fields["command"]["stringValue"] = "NONE";
  String jsonString;
  serializeJson(doc, jsonString);
  http.PATCH(jsonString);
  http.end();
}

// ==========================================
// MAIN LOOP
// ==========================================
void setup() {
  Serial.begin(115200);
  delay(1000);
  
  digitalWrite(RELAY_PIN, HIGH);
  pinMode(RELAY_PIN, INPUT);

  deviceId = loadDeviceId();
  if (deviceId == "") {
    deviceId = generateDeviceId();
    saveDeviceId(deviceId);
  }
  Serial.println("\nINTERNAL ID: " + deviceId);

  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nConnected!");
  
  registerBox();
  sendHeartbeat();
}

void loop() {
  checkCommand();

  if (millis() - lastPingTime > pingInterval) {
    lastPingTime = millis();
    sendHeartbeat();
  }
  
  delay(1000);
}